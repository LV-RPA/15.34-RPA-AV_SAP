import os 
import glob
import shutil

user_sap = ("RPA_SAP")
pass_sap = ("Anovo2020##")
user_inguz = ("74590179")
pass_inguz = ("jarvis")
link_inguz = ("www.anovo.pe/inguz")
link_carga = ("http://www.anovo.pe/inguz/formRutinas/frmCargarOrdenes.aspx")
traspaso = r'Z:\Traspaso.txt'
sap = (r'\\10.120.15.34\rutinas')
delete_files = (r'\\10.120.15.34\rutinas\*')

print("Revisar ultima carga")
for x in os.listdir(sap):
    filepath = os.path.join(x)

    if filepath == "CARGA OK.txt":
        ultimacarga = True

if ultimacarga == True:
    print("Todo OK")

    print("Cerrar procesos")
    os.system('taskkill /f /im saplogon.exe')
    os.system('taskkill /f /im firefox.exe')
    os.system('taskkill /f /im excel.exe')

    print("Eliminar Archivos")
    files = glob.glob(delete_files) 
    for f in files:
        os.remove(f)
    
    print("abrir firefox")
    App.open("C:\\Program Files\\Mozilla Firefox\\firefox.exe")
    sleep(15)
    
    print("iniciar sesion")
    paste(user_inguz)
    sleep(3)
    type(Key.TAB)
    sleep(3)
    paste(pass_inguz)
    sleep(3)
    type(Key.ENTER)
    sleep(5)
    wait("1571693125312-1.png",120)
    sleep(2)
    type("l",KEY_CTRL)
    sleep(2)
    
    print("ingresar al link de carga")
    paste(link_carga)
    sleep(2)
    type(Key.ENTER)
    sleep(15)
    click(Pattern("1559077079121-3.png").targetOffset(23,0))
    sleep(3)
    click(Pattern("1560624805320-1.png").targetOffset(2,5))
    sleep(2)
    click(Pattern("1570814672948.png").targetOffset(444,50))
    sleep(5)
    
    print("fin de descarga")
    type("w",KEY_CTRL)
    sleep(3)
    
    print("abrir sap")
    App.open("C:\\Program Files (x86)\\SAP\\FrontEnd\\SAPgui\\saplogon.exe")
    sleep(2)
    
    wait("1570656444611.png",120)
    sleep(5)
    doubleClick(Pattern("1570656458416.png").targetOffset(-1,12))
    
    print("ingresar usuario")
    sleep(3)
    wait(Pattern("1562366742430.png").similar(0.80),120)
    sleep(3)
    paste(user_sap)
    sleep(2)
    type(Key.TAB)
    sleep(2)
    paste(pass_sap)
    sleep(2)
    type(Key.ENTER)
    sleep(5)
    
    if exists("1563297931934.png",10):
        click(Pattern("1563983954890.png").targetOffset(-210,-32))
        click(Pattern("1563298018150.png").targetOffset(-12,1))
        sleep(10)

    if exists("1578760278198.png",10):
        sleep(2)
        click("1578760330541.png")
        sleep(10)
    
    print("buscar ruta")
    wait(Pattern("1562366972939.png").similar(0.80),120)
    sleep(2)
    type(Pattern("1562367026334-2.png").targetOffset(21,1),"ZMVT_NS_PE")
    sleep(2)
    type(Key.ENTER)
    sleep(5)
    type(Key.DELETE)
    sleep(5)
    paste(traspaso)
    sleep(2)
    type(Key.TAB)
    sleep(2)
    type(Key.TAB)
    sleep(2)
    paste("311")
    sleep(2)
    type(Key.F8)
    sleep(60)
    
    print("salir traspasos")
    click(Pattern("1565395767061-3.png").targetOffset(24,3))
    sleep(5)
    click(Pattern("1565395767061-3.png").targetOffset(23,1))
    sleep(5)
    
    print("ingresar iq09")
    type(Pattern("1562367026334.png").targetOffset(21,1),"iq09")
    sleep(2)
    type(Key.ENTER)
    sleep(2)
    
    print("insertar campos")
    wait(Pattern("1562369392776-1.png").similar(0.80),120)
    sleep(2)
    click(Pattern("1562369441189-1.png").targetOffset(4,-36))
    sleep(2)
    for step in range(10):
        click(Pattern("1562428479700.png").targetOffset(12,7))
    sleep(2)
    type(Pattern("1562369607242.png").targetOffset(97,3),"P102")
    sleep(5)
    type(Key.ENTER)
    sleep(8)
    click(Pattern("1562369788740.png").targetOffset(259,11))
    sleep(10)
    
    print("insertar almacenes")
    wait(Pattern("1562370023340-1.png").similar(0.80),120)
    sleep(2)
    click(Pattern("1568149848671.png").targetOffset(-45,2))
    sleep(10)
    
    def bodegas(inicio,fin):
        paste(inicio)
        sleep(2)
        type(Key.TAB)
        sleep(2)
        paste(fin)
        sleep(2)
        type(Key.TAB)
        sleep(2)
        type(Key.TAB)
        sleep(2)
        
    bodegas("ca01","ca99")
    bodegas("ct01","ct99")
    bodegas("at01","at99")
    bodegas("mv01","mv99")
    bodegas("cf13","cf99")
    bodegas("fc01","fc99")
    bodegas("af01","af99")
    bodegas("to13","to99")

    for step in range(2):
        click(Pattern("1581372440339.png").targetOffset(12,-4))
        sleep(2)
    click(Pattern("1581372644203.png").targetOffset(10,-16))
    sleep(2)
    bodegas("co01","co99")
    bodegas("ao01","ao99")
    sleep(3)
    
    print("inicio exportar iq09")
    type(Key.F8)
    sleep(2)
    wait("1562429385147-1.png",240)
    sleep(2)
    type(Key.F8)
    sleep(2)
    wait(Pattern("1562371475824-1.png").similar(0.80).targetOffset(-30,9),1800)
    sleep(5)
    rightClick(Pattern("1566937161824.png").targetOffset(7,1))
    sleep(10)
    type("h")
    sleep(5)
    wait(Pattern("1562371752040.png").similar(0.80),1800)
    sleep(5)
    click(Pattern("1562371993235.png").targetOffset(-12,3))
    sleep(2)
    
    print("exportar data")
    wait(Pattern("1562372032203.png").similar(0.80),1200)
    sleep(2)
    click(Pattern("1566921885165.png").targetOffset(4,27))
    sleep(2)
    click(Pattern("1562372092184.png").targetOffset(121,-2))
    sleep(2)
    click(Pattern("1562372254960.png").targetOffset(-91,1))
    sleep(2)
    click(Pattern("1562429989438.png").targetOffset(50,2))
    sleep(2)
    type(Key.DELETE)
    sleep(2)
    type("cargasap")
    sleep(2)
    click(Pattern("1562372353689-1.png").targetOffset(-3,3))
    sleep(25)
    
    if exists("1575933090657.png"):
        sleep(2)
        click(Pattern("1575933090657.png").targetOffset(-54,5))
        sleep(3)
        wait("1570057898554.png",120)
        sleep(3)
        type("a",KEY_ALT)
        sleep(2)
        click(Pattern("1571156917213.png").targetOffset(48,1))
        sleep(2)
        type("n")
        sleep(5)
        
    elif exists("1575931455658.png"):
        sleep(2)
        click(Pattern("1575932170416.png").targetOffset(22,1))
        sleep(5)
    
    else:
        wait("1570057898554.png",120)
        sleep(3)
        type("a",KEY_ALT)
        sleep(2)
        click(Pattern("1571156917213.png").targetOffset(48,1))
        sleep(2)
        type("n")
        sleep(5)
    
    print("salir iq09")
    sleep(5)
    click(Pattern("1565395767061-1.png").targetOffset(23,-1))
    sleep(5)
    click(Pattern("1565395767061-1.png").targetOffset(1,0))
    sleep(5)
    
    print("inicio exportar mb52")
    type(Pattern("1562367026334-1.png").targetOffset(21,1),"mb52")
    sleep(2)
    type(Key.ENTER)
    sleep(5)
    
    print("insertar campos")
    wait(Pattern("1562369392776-2.png").similar(0.80),240)
    sleep(4)
    click(Pattern("1568151300396.png").targetOffset(269,24))
    sleep(2)
    wait("1568151414749.png",240)
    sleep(2)
    paste("1568151414749.png","p102")
    sleep(1)
    type(Key.TAB)
    sleep(1)
    type(Key.TAB)
    sleep(1)
    paste("p100")
    sleep(1)
    type(Key.F8)
    sleep(5)
    click(Pattern("1568151597699.png").targetOffset(274,34))
    sleep(15)
    
    print("insertar almacenes")
    wait(Pattern("1562370023340-2.png").similar(0.80),240)
    sleep(2)
    click(Pattern("1568149848671-1.png").targetOffset(-41,1))
    sleep(5)

    bodegas("ca01","ca99")
    bodegas("ct01","ct99")
    bodegas("at01","at99")
    bodegas("mv01","mv99")
    bodegas("cf13","cf99")
    bodegas("fc01","fc99")
    bodegas("af01","af99")
    bodegas("to13","to99")

    for step in range(2):
        click(Pattern("1581372440339.png").targetOffset(12,-4))
        sleep(2)
    click(Pattern("1581372644203.png").targetOffset(10,-16))
    sleep(2)
    bodegas("co01","co99")
    bodegas("ao01","ao99")
    sleep(3)

    print("inicio exportar mb52")
    type(Key.F8)
    sleep(2)
    wait("1568151847517.png",1800)
    sleep(5)
    type(Key.F8)
    sleep(2)
    wait("1570049554719.png",240)
    sleep(5)
    rightClick(Pattern("1568152511662.png").targetOffset(15,1))
    sleep(15)
    type("h")
    sleep(5)
    wait(Pattern("1562371752040-1.png").similar(0.80),240)
    sleep(5)
    click(Pattern("1562371993235-1.png").targetOffset(-12,3))
    sleep(5)
    
    print("exportar data")
    wait(Pattern("1562372032203-1.png").similar(0.80),240)
    sleep(2)
    click(Pattern("1562429989438-1.png").targetOffset(50,2))
    sleep(2)
    type(Key.DELETE)
    sleep(2)
    type("materiales")
    sleep(2)
    click(Pattern("1562372353689-2.png").targetOffset(-3,3))
    sleep(25)
    
    if exists("1575933090657.png"):
        sleep(2)
        click(Pattern("1575933090657.png").targetOffset(-54,5))
        sleep(3)
        wait("1570057898554.png",120)
        sleep(3)
        type("a",KEY_ALT)
        sleep(2)
        click(Pattern("1571156917213.png").targetOffset(48,1))
        sleep(2)
        type("n")
        sleep(5)
    elif exists("1575931455658.png"):
        sleep(2)
        click(Pattern("1575932170416.png").targetOffset(22,1))
        sleep(5)
    
    else:
        wait("1570057898554.png",120)
        sleep(3)
        type("a",KEY_ALT)
        sleep(2)
        hover(Pattern("1570742091147.png").targetOffset(43,-2))
        sleep(2)
        click(Pattern("1570742169380.png").targetOffset(47,-4))
        sleep(2)
        type("n")
        sleep(5)
    
    print("salir mb52")
    sleep(5)
    click(Pattern("1565395767061-2.png").targetOffset(24,3))
    sleep(5)
    click(Pattern("1565395767061-2.png").targetOffset(23,1))
    sleep(5)
    
    print("salir sap")
    type("s",KEY_ALT)
    sleep(2)
    type("d")
    sleep(2)
    wait(Pattern("1562373385828-1.png").similar(0.80),120)
    sleep(2)
    click(Pattern("1562373410837-1.png").targetOffset(-45,-3))
    sleep(2)
    click(Pattern("1562373480298-1.png").targetOffset(17,2))
    sleep(7)
    
    print("abrir en excel")
    App.open("C:\\Program Files (x86)\\Microsoft Office\\root\\Office16\\excel.exe")
    sleep(2)
    wait("1574785806667.png",120)
    sleep(5)
    
    print("abrir el archivo traspaso")
    type("a",KEY_ALT)
    sleep(5)
    type("q",KEY_ALT)
    sleep(5)
    type("o",KEY_ALT)
    sleep(8)
    type("l",KEY_CTRL)
    sleep(3)
    paste(sap)
    sleep(2)
    type(Key.ENTER)
    sleep(2)
    click(Pattern("1562184036061-2.png").targetOffset(85,2))
    click(Pattern("1562184171093-2.png").targetOffset(-24,13))
    click(Pattern("1571084067081.png").targetOffset(-27,1))
    sleep(2)
    type(Key.ENTER)
    sleep(3)
    
    print("abrir traspaso")
    wait(Pattern("1562184472917-2.png").similar(0.80),120)
    sleep(2)
    type("f")
    sleep(2)
    wait("1571084162997-1.png",120)
    sleep(3)
    
    print("cambiar cabezeras")
    type("A")
    type(Key.RIGHT*7)
    sleep(2)
    type("Inicio")
    sleep(2)
    type(Key.RIGHT)
    sleep(2)
    type("Codigo de Material")
    sleep(2)
    type(Key.RIGHT*11)
    sleep(2)
    type("Traspaso")
    sleep(3)
    click(Pattern("1571766789978.png").targetOffset(-77,2))
    sleep(3)
    type("d",KEY_ALT)
    sleep(3)
    type("c")
    sleep(3)
    type("s")
    sleep(3)
    type("s")
    sleep(3)
    click(Pattern("1571766632518.png").targetOffset(-19,11))
    sleep(3)
    type("f")
    sleep(3)
    click(Pattern("1571765010025-1.png").targetOffset(81,3))
    sleep(3)
    type("d",KEY_ALT)
    sleep(3)
    type("c")
    sleep(3)
    type("s")
    sleep(3)
    type("s")
    sleep(3)
    click(Pattern("1571766632518.png").targetOffset(-19,11))
    sleep(3)
    type("f")
    sleep(3)
    
    print("Guardar Archivo")
    type("a",KEY_ALT)
    sleep(2)
    type("v",KEY_ALT)
    sleep(2)
    type("o",KEY_ALT)
    wait(Pattern("1562187507700-2.png").similar(0.80),120)
    sleep(2)
    type("traspasado")
    sleep(2)
    type(Key.TAB)
    sleep(2)
    type(Key.DOWN)
    sleep(2)
    type(Key.UP*8)
    sleep(2)
    type(Key.ENTER)
    sleep(3)
    type("l",KEY_CTRL)
    sleep(2)
    
    print("Guardar")
    paste(sap)
    sleep(2)
    type(Key.ENTER)
    sleep(2)
    click(Pattern("1562187840588-3.png").targetOffset(-1,1))
    sleep(5)
    click(Pattern("1566418579850-1.png").targetOffset(47,1))
    sleep(5)
    
    print("copiar archhivos")
    files = glob.glob('C:\\Rutinas\\*') 
    for f in files:
        shutil.copy(f,'\\\\10.10.1.250\\Desarrollo\\CargaInguz_Gestel\\')
    sleep(3)
    
    print("abrir firefox")
    App.open("C:\\Program Files\\Mozilla Firefox\\firefox.exe")
    sleep(20)
    
    print("iniciar sesion")
    paste(Pattern("1581520900393.png").targetOffset(-220,-32), user_inguz)
    sleep(5)
    type(Key.TAB)
    sleep(5)
    paste(pass_inguz)
    sleep(5)
    type(Key.ENTER)
    sleep(5)
    wait("1571693125312-1.png",120)
    sleep(2)
    type("l",KEY_CTRL)
    sleep(2)
    paste(link_carga)
    sleep(3)
    type(Key.ENTER)
    sleep(15)
    click(Pattern("1559077079121-4.png").targetOffset(23,0))
    sleep(3)
    click(Pattern("1560624805320-2.png").targetOffset(2,5))
    sleep(3)
    click(Pattern("1571086564157.png").targetOffset(-351,87))
    sleep(5)
    
    print("buscar el archivo")
    type("l",KEY_CTRL)
    sleep(2)
    paste(sap)
    sleep(2)
    type(Key.ENTER)
    sleep(2)
    click(Pattern("1571086603390.png").targetOffset(-30,2))
    sleep(2)
    type(Key.ENTER)
    sleep(2)
    click(Pattern("1571086646149.png").targetOffset(323,90))
    sleep(5)
    wait(Pattern("1560615777602.png").similar(0.80),240)
    
    print("Todo OK")
    archi1=open("C:\Rutinas\CARGA OK.txt","w") 
    archi1.close() 
  
    print("carga de materiales")
    sleep(5)
    type("l",KEY_CTRL)
    sleep(2)
    paste(link_carga)
    sleep(2)
    type(Key.ENTER)
    sleep(10)
    click(Pattern("1559077079121-2.png").targetOffset(23,0))
    sleep(3)
    click(Pattern("1560624805320.png").targetOffset(2,5))
    sleep(2)
    click(Pattern("1562427574666.png").similar(0.80).targetOffset(-20,90))
    sleep(5)
    
    print("cargar seriados")
    type("l",KEY_CTRL)
    sleep(2)
    paste(sap)
    sleep(2)
    type(Key.ENTER)
    sleep(2)
    click(Pattern("1570039181541.png").targetOffset(-26,6))
    sleep(2)
    type(Key.ENTER)
    sleep(2)
    click(Pattern("1562428210958.png").targetOffset(328,13))
    sleep(5)
    wait(Pattern("1560625035541.png").similar(0.80),120)
    sleep(5)
    
    print("cargar no seriados")
    type("l",KEY_CTRL)
    sleep(2)
    paste(link_carga)
    sleep(2)
    type(Key.ENTER)
    sleep(10)
    click(Pattern("1559077079121-2.png").targetOffset(23,0))
    sleep(3)
    click(Pattern("1560624805320.png").targetOffset(2,5))
    sleep(2)
    click(Pattern("1570814282068.png").targetOffset(-148,10))
    sleep(3)
    type("l",KEY_CTRL)
    sleep(3)
    paste(sap)
    sleep(2)
    type(Key.ENTER)
    sleep(3)
    click(Pattern("1580842385640.png").targetOffset(-31,1))
    sleep(2)
    type(Key.ENTER)
    sleep(3)
    click(Pattern("1580837249241.png").targetOffset(341,15))
    sleep(8)
    wait(Pattern("1560625035541.png").similar(0.80),120)
    sleep(5)
    
    print("fin de la carga")
    type("w",KEY_CTRL)
    sleep(2)

else:
    print("problemas con la carga")
    type("w",KEY_CTRL)
    print("MEY DAY MEY DAY")